
&НаКлиенте
Процедура ТоварыСуммаПриИзменении(Элемент)
	Объект.СуммаНакладной = Объект.Товары.Итог("Сумма");
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
	РазмерКредитаК = ПолучитьКредитКонтрагента() - ПолучитьОстатки(); 
Иначе РазмерКредитаК = ПолучитьКредитКонтрагента() - ПолучитьОстаткиБезДока();
	КонецЕсли;
	Если РазмерКредитаК >= Объект.Товары.Итог("Сумма") Тогда 
	ИначеЕсли РазмерКредитаК < Объект.Товары.Итог("Сумма") Тогда 
		Отказ=Истина;
	КонецЕсли;
КонецПроцедуры

Функция ПолучитьКредитКонтрагента()
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Контрагент.РазмерКредита КАК РазмерКредита
		|ИЗ
		|	Справочник.Контрагент КАК Контрагент
		|ГДЕ
		|	Контрагент.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Объект.Контрагент.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Возврат ВыборкаДетальныеЗаписи.РазмерКредита;
	КонецЦикла;
			
КонецФункции

&НаКлиенте
Процедура ТоварыПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		РазмерКредитаК = ПолучитьКредитКонтрагента() - ПолучитьОстатки(); 
	Иначе РазмерКредитаК = ПолучитьКредитКонтрагента() - ПолучитьОстаткиБезДока();
	КонецЕсли;
	
	Если РазмерКредитаК >= Объект.Товары.Итог("Сумма") Тогда 
	ИначеЕсли РазмерКредитаК < Объект.Товары.Итог("Сумма") Тогда 
		Отказ=Истина;
	КонецЕсли; 
	Если Отказ Тогда  
		ИдентификаторСтроки = Элементы.Товары.ТекущаяСтрока;
		ЭлементКоллекции = Объект.Товары.НайтиПоИдентификатору(ИдентификаторСтроки);
		ИндексЭлементаКоллекции = Объект.Товары.Индекс(ЭлементКоллекции);
		Объект.Товары.Удалить(ИндексЭлементаКоллекции);
	КонецЕсли;
	ТоварыСуммаПриИзменении(Элемент);
КонецПроцедуры

Функция ПолучитьОстатки()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(УправленческийДвиженияССубконто.СуммаПродаж) КАК СуммаПродаж,
	|	СУММА(УправленческийДвиженияССубконто.СуммаОплаты) КАК СуммаОплаты
	|ИЗ
	|	РегистрБухгалтерии.Управленческий.ДвиженияССубконто КАК УправленческийДвиженияССубконто
	|ГДЕ
	|	УправленческийДвиженияССубконто.СубконтоДт1 = &СубконтоДт1
	|
	|СГРУППИРОВАТЬ ПО
	|	УправленческийДвиженияССубконто.СубконтоДт1";
	
	Запрос.УстановитьПараметр("СубконтоДт1", Объект.Контрагент.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		 Возврат ВыборкаДетальныеЗаписи.СуммаПродаж - ВыборкаДетальныеЗаписи.СуммаОплаты;
	КонецЦикла;
	
КонецФункции   

 Функция ПолучитьОстаткиБезДока()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(УправленческийДвиженияССубконто.СуммаПродаж) КАК СуммаПродаж,
	|	СУММА(УправленческийДвиженияССубконто.СуммаОплаты) КАК СуммаОплаты
	|ИЗ
	|	РегистрБухгалтерии.Управленческий.ДвиженияССубконто КАК УправленческийДвиженияССубконто
	|ГДЕ
	|	УправленческийДвиженияССубконто.СубконтоДт1 = &СубконтоДт1
	|	И УправленческийДвиженияССубконто.Регистратор <> &Регистратор
	|
	|СГРУППИРОВАТЬ ПО
	|	УправленческийДвиженияССубконто.СубконтоДт1";
	
	Запрос.УстановитьПараметр("СубконтоДт1", Объект.Контрагент.Ссылка);
	Запрос.УстановитьПараметр("Регистратор", Объект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		 Возврат ВыборкаДетальныеЗаписи.СуммаПродаж - ВыборкаДетальныеЗаписи.СуммаОплаты;
	КонецЦикла;
	
КонецФункции  
