БУХ ЧЕТ СКИДКА РАСХОДНАЯ
Процедура ОбработкаПроведения(Отказ, Режим)
запрос = новый запрос;
	запрос.Текст = "ВЫБРАТЬ
	               |	ЦенаНоменклатурыСрезПоследних.Цена КАК Цена
	               |ИЗ
	               |	РегистрСведений.ЦенаНоменклатуры.СрезПоследних(&дата, ) КАК ЦенаНоменклатурыСрезПоследних
	               |ГДЕ
	               |	ЦенаНоменклатурыСрезПоследних.Номенклатура = &Товар";               
	запрос.УстановитьПараметр("дата",КонецМесяца(ДобавитьМесяц(Дата,-1)));		
	
	// регистр Управленческий 
	Движения.Управленческий.Записывать = Истина;
	Для Каждого ТекСтрокаПродажа Из Товары Цикл
		Движение = Движения.Управленческий.Добавить();
		Движение.СчетДт = ПланыСчетов.Основной.Капитал;
		Движение.СчетКт = ПланыСчетов.Основной.Товары;
		Движение.Период = Дата;

		запрос.УстановитьПараметр("товар",ТекСтрокаПродажа.номенклатура);
	выборка = запрос.выполнить().выбрать();
	если выборка.следующий() тогда              
		 Движение.Сумма = выборка.цена * ТекСтрокаПродажа.Количество;			
	конецесли;		
		
		Движение.Количество = ТекСтрокаПродажа.Количество;
		Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = ТекСтрокаПродажа.номенклатура;
	КонецЦикла;

	// регистр Управленческий 
	Движения.Управленческий.Записывать = Истина;
	Для Каждого ТекСтрокаПродажа Из Товары Цикл
		Движение = Движения.Управленческий.Добавить();
		Движение.СчетДт = ПланыСчетов.Основной.Дебиторка;
		Движение.СчетКт = ПланыСчетов.Основной.Капитал;
		Движение.Период = Дата;
		Движение.Сумма = ТекСтрокаПродажа.СуммаСоСкидкой;
		Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Контрагент;
		Движение.СписочнаяЦена = ТекСтрокаПродажа.Цена * ТекСтрокаПродажа.Количество;
		Движение.Скидка = Скидка;
	КонецЦикла;


КонецПроцедуры

СКИДКА
Функция ПолучитьСкидку(Контрагент)
			
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	УправленческийОборотыДтКт.СуммаОборот КАК СуммаОборот,
		|	УправленческийОборотыДтКт.СубконтоДт1 КАК СубконтоДт1
		|ИЗ
		|	РегистрБухгалтерии.Управленческий.ОборотыДтКт(&началопериода, &конецпериода, , , , , , СубконтоДт1 = &Контрагент) КАК УправленческийОборотыДтКт";
	
	Запрос.УстановитьПараметр("конецпериода", КонецМесяца(ДобавитьМесяц(Объект.Дата,-1)));
	Запрос.УстановитьПараметр("началопериода", НачалоМесяца(ДобавитьМесяц(Объект.Дата,-1)));;
	Запрос.УстановитьПараметр("счетдт", ПланыСчетов.Основной.Товары);
	Запрос.УстановитьПараметр("счеткт", ПланыСчетов.Основной.РасчетСПоставщиками);
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
		
		Если ВыборкаДетальныеЗаписи.СуммаОборот > 1000 И ВыборкаДетальныеЗаписи.СуммаОборот < 3000 Тогда
        	Возврат 2;	
		КонецЕсли;  
		
		Если ВыборкаДетальныеЗаписи.СуммаОборот > 3000 И ВыборкаДетальныеЗаписи.СуммаОборот < 5000 Тогда
        	Возврат 5;	
		КонецЕсли;
		
		Если ВыборкаДетальныеЗаписи.СуммаОборот > 5000 И ВыборкаДетальныеЗаписи.СуммаОборот < 10000 Тогда
        	Возврат 10;	
		КонецЕсли;
		
		Если ВыборкаДетальныеЗаписи.СуммаОборот > 10000 Тогда
        	Возврат 15;	
		КонецЕсли;
		
		Возврат 0;
		
	Иначе
		Возврат 0;		
	Конецесли;
КонецФункции

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	Объект.Скидка = ПолучитьСкидку(Объект.Контрагент);
	Объект.СуммаБезСкидки = 0;  
	Для Каждого Стр из Объект.Товары Цикл
		Стр.ЦенаСоСкидкой = Стр.Цена*(100-Объект.Скидка)/100; 
		Стр.СуммаСоСкидкой = Стр.ЦенаСоСкидкой * Стр.Количество;
		Объект.СуммаБезСкидки = Объект.СуммаБезСкидки + Стр.Сумма;
	КонецЦикла;
	Объект.ОбщаяСумма = Объект.СуммаБезСкидки*(100-Объект.Скидка)/100;
КонецПроцедуры

ОТЧЕТ
ВЫБРАТЬ
	УправленческийДвиженияССубконто.СубконтоДт1 КАК СубконтоДт1,
	СУММА(УправленческийДвиженияССубконто.Сумма) КАК Сумма,
	СРЕДНЕЕ(УправленческийДвиженияССубконто.Скидка) КАК Скидка,
	СУММА(УправленческийДвиженияССубконто.СписочнаяЦена) КАК СписочнаяЦена
ИЗ
	РегистрБухгалтерии.Управленческий.ДвиженияССубконто(&НачалоПериода, &КонецПериода, , , ) КАК УправленческийДвиженияССубконто
ГДЕ
	УправленческийДвиженияССубконто.СчетКт = &СчетКт

СГРУППИРОВАТЬ ПО
	УправленческийДвиженияССубконто.СубконтоДт1

ЗАКУПКА

Процедура ОбработкаПроведения(Отказ, Режим)
	//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!

	// регистр Управленческий 
	Движения.Управленческий.Записывать = Истина;
	Для Каждого ТекСтрокаЗакупка Из Закупка Цикл
		Движение = Движения.Управленческий.Добавить();
		Движение.СчетДт = ПланыСчетов.Основной.Товары;
		Движение.СчетКт = ПланыСчетов.Основной.РасчетСПоставщиками;
		Движение.Период = Дата;
		Движение.Сумма = ТекСтрокаЗакупка.Итого;
		Движение.Количество = ТекСтрокаЗакупка.Количество;
		Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = ТекСтрокаЗакупка.Товар;
	КонецЦикла;

	//}}__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
КонецПроцедуры

ОПЕР УЧЕТ

&НаКлиенте
Процедура ПересчитатьДопСуммуУслуг(СтрУс)

	ИтогПоЦене = Объект.РасходТоваров.Итог("Цена");
	Для Каждого Стр Из Объект.РасходТоваров Цикл
		
		ДоляПроцентаОтИтогЦены = Стр.Цена * 100 / ИтогПоЦене;
		Стр.СтоимостьДопУслуг = Стр.СтоимостьДопУслуг + (СтрУс.Цена * ДоляПроцентаОтИтогЦены / 100);
		
	КонецЦикла; 

КонецПроцедуры 


